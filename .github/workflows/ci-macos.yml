name: ci-macos

on:
  pull_request:
  push:
    branches:
      - main
      - feat/**
      - feature/**
  workflow_dispatch:

permissions:
  contents: read

jobs:
  compatibility-tests:
    strategy:
      fail-fast: false
      matrix:
        os:
          - macos-14
          - macos-latest
    runs-on: ${{ matrix.os }}
    env:
      PROJECT_PATH: AwakeBar.xcodeproj
      SCHEME: AwakeBar

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install xcodegen
        run: |
          if ! command -v xcodegen >/dev/null 2>&1; then
            brew install xcodegen
          fi

      - name: Generate Xcode project
        run: xcodegen generate

      - name: Run compatibility-focused tests
        run: |
          set -euo pipefail
          xcodebuild \
            -project "$PROJECT_PATH" \
            -scheme "$SCHEME" \
            -configuration Debug \
            -destination "platform=macOS" \
            -only-testing:AwakeBarPrivilegedHelperTests/PrivilegedServiceTests \
            -only-testing:AwakeBarTests/ClosedLidPmsetControllerTests \
            -only-testing:AwakeBarTests/MenuBarControllerTests \
            -only-testing:AwakeBarTests/PrivilegedDaemonClientTests \
            test

  test-and-smoke:
    runs-on: macos-14
    env:
      PROJECT_PATH: AwakeBar.xcodeproj
      SCHEME: AwakeBar

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install xcodegen
        run: |
          if ! command -v xcodegen >/dev/null 2>&1; then
            brew install xcodegen
          fi

      - name: Generate Xcode project
        run: xcodegen generate

      - name: Run unit tests
        run: |
          set -euo pipefail
          xcodebuild \
            -project "$PROJECT_PATH" \
            -scheme "$SCHEME" \
            -configuration Debug \
            -destination "platform=macOS" \
            test

      - name: Build Release app bundle
        run: |
          set -euo pipefail
          rm -rf build/DerivedDataCI
          xcodebuild \
            -project "$PROJECT_PATH" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination "generic/platform=macOS" \
            -derivedDataPath build/DerivedDataCI \
            build

      - name: Smoke-check packaged app
        run: |
          set -euo pipefail
          APP_PATH="$PWD/build/DerivedDataCI/Build/Products/Release/AwakeBar.app"
          [[ -d "$APP_PATH" ]]
          ./Scripts/smoke-check-app.sh "$APP_PATH"

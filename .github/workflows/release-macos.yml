name: release-macos

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-14
    env:
      APP_NAME: AwakeBar
      PROJECT_PATH: AwakeBar.xcodeproj
      SCHEME: AwakeBar
      CONFIGURATION: Release
      ARCHIVE_PATH: build/AwakeBar.xcarchive
      APP_PATH: build/AwakeBar.app
      ZIP_UNSIGNED: build/AwakeBar-unsigned.zip
      ZIP_STAPLED: build/AwakeBar-macos.zip

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install xcodegen
        run: |
          if ! command -v xcodegen >/dev/null 2>&1; then
            brew install xcodegen
          fi

      - name: Prepare signing and notarization assets
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_API_KEY_P8_BASE64: ${{ secrets.ASC_API_KEY_P8_BASE64 }}
          DEVELOPER_ID_APP_CERT_P12_BASE64: ${{ secrets.DEVELOPER_ID_APP_CERT_P12_BASE64 }}
          DEVELOPER_ID_APP_CERT_PASSWORD: ${{ secrets.DEVELOPER_ID_APP_CERT_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          set -euo pipefail
          echo "$DEVELOPER_ID_APP_CERT_P12_BASE64" | base64 --decode > "$RUNNER_TEMP/dev_id_app.p12"
          echo "$ASC_API_KEY_P8_BASE64" | base64 --decode > "$RUNNER_TEMP/AuthKey_${ASC_KEY_ID}.p8"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$RUNNER_TEMP/build.keychain-db"
          security set-keychain-settings -lut 21600 "$RUNNER_TEMP/build.keychain-db"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$RUNNER_TEMP/build.keychain-db"
          security import "$RUNNER_TEMP/dev_id_app.p12" \
            -k "$RUNNER_TEMP/build.keychain-db" \
            -P "$DEVELOPER_ID_APP_CERT_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security
          if [[ -f "$HOME/Library/Keychains/login.keychain-db" ]]; then
            security list-keychains -d user -s "$RUNNER_TEMP/build.keychain-db" "$HOME/Library/Keychains/login.keychain-db"
          else
            security list-keychains -d user -s "$RUNNER_TEMP/build.keychain-db"
          fi
          security set-key-partition-list \
            -S apple-tool:,apple:,codesign: \
            -s \
            -k "$KEYCHAIN_PASSWORD" \
            "$RUNNER_TEMP/build.keychain-db"

          if ! security find-identity -v -p codesigning "$RUNNER_TEMP/build.keychain-db" | grep -Eq "Developer ID Application: .*\($APPLE_TEAM_ID\)"; then
            echo "Missing required signing identity: Developer ID Application for team $APPLE_TEAM_ID" >&2
            exit 1
          fi

          xcrun notarytool history \
            --key "$RUNNER_TEMP/AuthKey_${ASC_KEY_ID}.p8" \
            --key-id "$ASC_KEY_ID" \
            --issuer "$ASC_ISSUER_ID" \
            --output-format json >/dev/null

      - name: Generate Xcode project
        run: xcodegen generate

      - name: Archive Release build
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set -euo pipefail
          rm -rf build
          xcodebuild \
            -project "$PROJECT_PATH" \
            -scheme "$SCHEME" \
            -configuration "$CONFIGURATION" \
            -destination "generic/platform=macOS" \
            -archivePath "$ARCHIVE_PATH" \
            archive \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
            AWAKEBAR_TEAM_ID="$APPLE_TEAM_ID" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Developer ID Application" \
            OTHER_CODE_SIGN_FLAGS="--keychain $RUNNER_TEMP/build.keychain-db"

          ditto \
            "$ARCHIVE_PATH/Products/Applications/${APP_NAME}.app" \
            "$APP_PATH"

      - name: Verify signature
        run: |
          set -euo pipefail
          codesign --verify --deep --strict --verbose=2 "$APP_PATH"
          spctl --assess --type exec --verbose=4 "$APP_PATH"

      - name: Smoke-check packaged app
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set -euo pipefail
          ./Scripts/smoke-check-app.sh "$APP_PATH" "$APPLE_TEAM_ID"

      - name: Zip for notarization
        run: |
          set -euo pipefail
          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "$ZIP_UNSIGNED"

      - name: Notarize
        env:
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
        run: |
          set -euo pipefail
          xcrun notarytool submit "$ZIP_UNSIGNED" \
            --key "$RUNNER_TEMP/AuthKey_${ASC_KEY_ID}.p8" \
            --key-id "$ASC_KEY_ID" \
            --issuer "$ASC_ISSUER_ID" \
            --wait

      - name: Staple and package final ZIP
        run: |
          set -euo pipefail
          xcrun stapler staple "$APP_PATH"
          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "$ZIP_STAPLED"
          shasum -a 256 "$ZIP_STAPLED" > "$ZIP_STAPLED.sha256"

      - name: Publish GitHub Release assets
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            build/AwakeBar-macos.zip
            build/AwakeBar-macos.zip.sha256

      - name: Cleanup sensitive runner files
        if: always()
        run: |
          rm -f "$RUNNER_TEMP/dev_id_app.p12" "$RUNNER_TEMP"/AuthKey_*.p8
          security delete-keychain "$RUNNER_TEMP/build.keychain-db" || true

---
doc_type: feature_spec
id: F-004.04
name: Lock on Lid Close
status: active
owner: dshakiba
parent: F-004
children: []
aliases:
  - Lid Close Lock
version: 1.1.0
last_reviewed: 2026-02-20
tags:
  - clamshell
  - lock
  - menu
risk_level: medium
dependencies:
  - F-002
  - F-004
---

# [F-004.04] Lock on Lid Close

## Summary

Provide an optional menu setting that locks the computer on lid-close events while `Full Awake` is actively ON.

## Goals

- Add an explicit user-controlled lock-on-lid-close setting.
- Keep lock behavior gated to active Full Awake sessions.
- Preserve safe fallback behavior across macOS variants.

## Non-Goals

- Locking when Full Awake is OFF.
- Expanding privileged helper command surface for locking.
- Guaranteeing one specific hard-lock binary on every macOS build.

## Requirements

- R1: Menu must expose `Lock Computer on Lid Close` in inline `Settings` only when lid-state hardware support is available.
- R2: Lock-on-lid-close execution must require all gates: setting enabled, `Full Awake` ON, and lid support available.
- R3: Lid-close handling must be edge-based and trigger a single lock attempt per close cycle.
- R4: Lock attempts must use best-effort command order: known `CGSession -suspend` paths first, then `ScreenSaverEngine` fallback.
- R5: Lock failures must surface as transient menu errors and must not mutate runtime Full Awake state flags.
- R6: Wait-based lock commands must use bounded timeouts and the lock path must never hang indefinitely.
- R7: Lock orchestration must be transition-safe: monitoring is disabled while `Full Awake` transitions OFF, and queued close events must re-check gates before locking.
- R8: Lock attempts must be single-flight; close-edge events that arrive while a lock attempt is in flight must not run parallel lock commands.

<!-- AUTOGEN:REQUIREMENTS_CHECKLIST -->
- [x] R1
- [x] R2
- [x] R3
- [x] R4
- [x] R5
- [x] R6
- [x] R7
- [x] R8

## Acceptance Criteria

- AC1: With all gates true, one close cycle triggers one lock attempt; repeated close notifications without reopen do not double-trigger.
- AC2: With Full Awake OFF, lid-close events do not trigger lock attempts.
- AC3: With lock preference OFF, lid-close events do not trigger lock attempts.
- AC4: Lock-on-lid-close preference persists across relaunch with default OFF for fresh installs.
- AC5: If a lid-close event is queued but `Full Awake` turns OFF before execution, no lock command runs.
- AC6: Rapid close-edge events while a lock attempt is running do not execute parallel lock commands.
- AC7: If a wait-based lock command times out, fallback progression continues and returns promptly.

<!-- AUTOGEN:ACCEPTANCE_CHECKLIST -->
- [x] AC1
- [x] AC2
- [x] AC3
- [x] AC4
- [x] AC5
- [x] AC6
- [x] AC7

## Traceability

<!-- AUTOGEN:TRACEABILITY -->
| Item | Type | Evidence |
|---|---|---|
| R1 | code | AwakeBar/UI/MenuContentView.swift |
| R2 | code | AwakeBar/App/MenuBarController.swift |
| R3 | code | AwakeBar/App/MenuBarController.swift |
| R3 | code | AwakeBar/Services/IOKitLidStateMonitor.swift |
| R4 | code | AwakeBar/Services/ComputerLockController.swift |
| R5 | code | AwakeBar/App/MenuBarController.swift |
| R6 | code | AwakeBar/Services/ComputerLockController.swift |
| R7 | code | AwakeBar/App/MenuBarController.swift |
| R8 | code | AwakeBar/App/MenuBarController.swift |
| AC1 | test | AwakeBarTests/MenuBarControllerTests.swift |
| AC2 | test | AwakeBarTests/MenuBarControllerTests.swift |
| AC3 | test | AwakeBarTests/MenuBarControllerTests.swift |
| AC4 | test | AwakeBarTests/AppStateStoreTests.swift |
| AC5 | test | AwakeBarTests/MenuBarControllerTests.swift |
| AC6 | test | AwakeBarTests/MenuBarControllerTests.swift |
| AC7 | test | AwakeBarTests/ComputerLockControllerTests.swift |

## Children

<!-- AUTOGEN:CHILDREN -->
- None

## References

<!-- AUTOGEN:REFERENCES -->
- [F-002](./F-002-menu-bar-experience.md)
- [F-004](./F-004-state-persistence-login.md)
- [F-004.02](./F-004.02-launch-at-login-control.md)

## API Contract

<!-- AUTOGEN:API_CONTRACT_SUMMARY -->
- `LidStateMonitoring`
- `ComputerLockControlling`
- `MenuBarController.setLockOnLidCloseEnabled(_:)`
- `AppState.lockOnLidCloseEnabled`

## Impact

<!-- AUTOGEN:IMPACT_MAP -->
- Adds optional safety lock behavior for closed-lid Full Awake sessions.
- Keeps lock workflow entirely in app process without helper API expansion.

## Security

<!-- AUTOGEN:SECURITY_CHECKLIST -->
- [x] No credential storage or credential prompts
- [x] No privileged helper command expansion for lock flow
- [x] Fails safely with transient messaging when lock command chain fails

## Budget

<!-- AUTOGEN:BUDGET_CHECKLIST -->
- [x] Event-driven monitor lifecycle gated by active Full Awake + preference
- [x] No continuous polling loop

## Table of Contents

<!-- AUTOGEN:TOC -->
- Summary
- Goals
- Non-Goals
- Requirements
- Acceptance Criteria

<!-- DO NOT EDIT BELOW (AUTOGENERATED) -->

## Changelog

- 2026-02-20: Initial child spec created for lock-on-lid-close behavior and gating model.
- 2026-02-20: Added non-blocking lock fallback, transition-safe gate re-checking, and single-flight lock requirements with direct regression coverage.

---
doc_type: feature_spec
id: F-004
name: State Persistence and Login
status: active
owner: dshakiba
parent: null
children:
  - F-004.01
  - F-004.02
  - F-004.03
aliases: []
version: 1.6.0
last_reviewed: 2026-02-21
tags:
  - persistence
  - login-item
risk_level: low
dependencies:
  - F-002
---

# [F-004] State Persistence and Login

## Summary

Persist only safe state, retain deterministic login preferences, and preserve bounded restore metadata for closed-lid override recovery.

## Goals

- Keep relaunch behavior safe by default (no persisted Full Awake ON intent).
- Restore previously captured system sleep policy after app-managed closed-lid sessions.
- Persist login preference plus migration completion state with explicit recovery metadata.

## Non-Goals

- Cross-device settings sync.
- Persisting privileged runtime state that may be stale or unsafe.

## Requirements

- R1: Persist launch-at-login preference, legacy cleanup completion marker, and closed-lid override session metadata only.
- R2: Never persist runtime closed-lid/open-lid state flags (for example `openLidEnabled`, `closedLidEnabledByApp`) or transient UI/error fields.
- R3: Bootstrap must reset runtime awake flags, attempt pending override-session restore, and then refresh live setup/runtime status.
- R4: Login toggle must drive `SMAppService.mainApp` registration state.
- R5: Persistence layer must clear legacy restore-intent keying and drop unreadable/unknown override-session payloads.

<!-- AUTOGEN:REQUIREMENTS_CHECKLIST -->
- [x] R1
- [x] R2
- [x] R3
- [x] R4
- [x] R5

## Acceptance Criteria

- AC1: Relaunch does not auto-enable Full Awake; runtime awake flags reset to OFF by default.
- AC2: Pending override sessions retry on launch/refresh and clear persisted session state after a successful restore.
- AC3: Launch-at-login preference changes are persisted and reloaded.
- AC4: Invalid override-session payloads are discarded without crashing and legacy restore-intent key is removed.

<!-- AUTOGEN:ACCEPTANCE_CHECKLIST -->
- [x] AC1
- [x] AC2
- [x] AC3
- [x] AC4

## Traceability

<!-- AUTOGEN:TRACEABILITY -->
| Item | Type | Evidence |
|---|---|---|
| R1 | code | AwakeBar/State/AppStateStore.swift |
| R1 | code | AwakeBar/Domain/ClosedLidOverrideSession.swift |
| R2 | code | AwakeBar/State/AppStateStore.swift |
| R3 | code | AwakeBar/App/MenuBarController.swift |
| R4 | code | AwakeBar/Services/LoginItemController.swift |
| R5 | code | AwakeBar/State/AppStateStore.swift |
| AC1 | test | AwakeBarTests/MenuBarControllerTests.swift |
| AC2 | test | AwakeBarTests/MenuBarControllerTests.swift |
| AC3 | test | AwakeBarTests/MenuBarControllerTests.swift |
| AC3 | test | AwakeBarTests/AppStateStoreTests.swift |
| AC4 | test | AwakeBarTests/AppStateStoreTests.swift |

## Children

<!-- AUTOGEN:CHILDREN -->
- [F-004.01](./F-004.01-safe-state-persistence-boundary.md)
- [F-004.02](./F-004.02-launch-at-login-control.md)
- [F-004.03](./F-004.03-closed-lid-override-session-recovery.md)

## References

<!-- AUTOGEN:REFERENCES -->
- [F-002](./F-002-menu-bar-experience.md)
- [F-004.01](./F-004.01-safe-state-persistence-boundary.md)
- [F-004.02](./F-004.02-launch-at-login-control.md)
- [F-004.03](./F-004.03-closed-lid-override-session-recovery.md)
- [F-003](./F-003-closed-lid-admin-control.md)

## API Contract

<!-- AUTOGEN:API_CONTRACT_SUMMARY -->
- `AppStateStore.load()`
- `AppStateStore.save(_:)`
- `AppStateStore.loadOverrideSession()`
- `AppStateStore.saveOverrideSession(_:)`
- `LoginItemControlling`

## Impact

<!-- AUTOGEN:IMPACT_MAP -->
- Controls startup behavior and persistence safety boundaries.
- Enables one-time migration cleanup idempotency across relaunches.
- Enables deterministic closed-lid baseline restore and retry semantics across quit/relaunch.

## Security

<!-- AUTOGEN:SECURITY_CHECKLIST -->
- [x] Local-only persistence via `UserDefaults`
- [x] Does not cache credentials or privileged tokens
- [x] Drops unreadable or schema-mismatched override-session payloads

## Budget

<!-- AUTOGEN:BUDGET_CHECKLIST -->
- [x] O(1) load/save operations
- [x] No background sync loops

## Table of Contents

<!-- AUTOGEN:TOC -->
- Summary
- Goals
- Non-Goals
- Requirements
- Acceptance Criteria

<!-- DO NOT EDIT BELOW (AUTOGENERATED) -->

## Changelog

- 2026-02-17: Initial spec created.
- 2026-02-18: Added migration marker persistence for daemon cutover cleanup idempotency.
- 2026-02-18: Split persistence and login-item responsibilities into child specs.
- 2026-02-18: Updated Full Awake terminology for persisted awake intent.
- 2026-02-19: Removed unused transient state fields from persistence boundary and clarified R2 wording.
- 2026-02-19: Added closed-lid override session recovery semantics and child spec linkage.

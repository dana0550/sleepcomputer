---
doc_type: feature_spec
id: F-004
name: State Persistence and Login
status: active
owner: dshakiba
parent: null
children: []
aliases: []
version: 1.0.0
last_reviewed: 2026-02-17
tags:
  - persistence
  - login-item
risk_level: low
dependencies:
  - F-002
---

# [F-004] State Persistence and Login

## Summary

Persist safe state and expose launch-at-login as a user-controlled toggle.

## Goals

- Restore Full Caffeine and login preference across relaunches.
- Avoid auto-restoring closed-lid mode.

## Non-Goals

- Sync settings between devices.

## Requirements

- R1: Persist open-lid and launch-at-login settings to local defaults.
- R2: Do not persist closed-lid enabled state.
- R3: Login setting toggles SMAppService registration state.

<!-- AUTOGEN:REQUIREMENTS_CHECKLIST -->
- [ ] R1
- [ ] R2
- [ ] R3

## Acceptance Criteria

- AC1: Relaunch restores Full Caffeine state.
- AC2: Relaunch requires explicit action for closed-lid mode.
- AC3: Login toggle survives logout/login.

<!-- AUTOGEN:ACCEPTANCE_CHECKLIST -->
- [ ] AC1
- [ ] AC2
- [ ] AC3

## Traceability

<!-- AUTOGEN:TRACEABILITY -->
| Item | Type | Evidence |
|---|---|---|
| R1 | test | AwakeBarTests/AppStateStoreTests.swift |
| R2 | test | AwakeBarTests/AppStateStoreTests.swift |
| R3 | test | AwakeBarTests/MenuBarControllerTests.swift |
| AC1 | manual | Relaunch validation |
| AC2 | manual | Relaunch validation |
| AC3 | manual | Login item validation |

## Children

<!-- AUTOGEN:CHILDREN -->
- None

## References

<!-- AUTOGEN:REFERENCES -->
- [F-002]

## API Contract

<!-- AUTOGEN:API_CONTRACT_SUMMARY -->
- `AppStateStore`
- `LoginItemControlling`

## Impact

<!-- AUTOGEN:IMPACT_MAP -->
- Startup behavior and persisted user experience.

## Security

<!-- AUTOGEN:SECURITY_CHECKLIST -->
- [x] Local-only persistence via UserDefaults

## Budget

<!-- AUTOGEN:BUDGET_CHECKLIST -->
- [x] O(1) load/save persistence operations

## Table of Contents

<!-- AUTOGEN:TOC -->
- Summary
- Goals
- Requirements
- Acceptance Criteria

<!-- DO NOT EDIT BELOW (AUTOGENERATED) -->

## Changelog

- 2026-02-17: Initial spec created.

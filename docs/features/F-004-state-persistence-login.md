---
doc_type: feature_spec
id: F-004
name: State Persistence and Login
status: active
owner: dshakiba
parent: null
children:
  - F-004.01
  - F-004.02
aliases: []
version: 1.3.0
last_reviewed: 2026-02-19
tags:
  - persistence
  - login-item
risk_level: low
dependencies:
  - F-002
---

# [F-004] State Persistence and Login

## Summary

Persist safe state and keep launch-at-login preference control available through app controllers.

## Goals

- Restore Full Awake intent and login preference across relaunches.
- Avoid auto-restoring closed-lid mode.
- Persist migration completion state for one-time cleanup behavior.

## Non-Goals

- Cross-device settings sync.
- Persisting privileged runtime state that may be stale or unsafe.

## Requirements

- R1: Persist open-lid enabled state, launch-at-login preference, and legacy cleanup completion marker.
- R2: Never persist runtime closed-lid state (for example `closedLidEnabledByApp`) or transient UI/error fields.
- R3: Bootstrap must reset closed-lid runtime state and refresh live setup/runtime status.
- R4: Login toggle must drive `SMAppService.mainApp` registration state.

<!-- AUTOGEN:REQUIREMENTS_CHECKLIST -->
- [x] R1
- [x] R2
- [x] R3
- [x] R4

## Acceptance Criteria

- AC1: Relaunch restores prior Full Awake intent (via open-lid persistence) and launch-at-login preference.
- AC2: Relaunch does not auto-enable closed-lid by-app state.
- AC3: Login toggle changes are persisted and reloaded.

<!-- AUTOGEN:ACCEPTANCE_CHECKLIST -->
- [x] AC1
- [x] AC2
- [x] AC3

## Traceability

<!-- AUTOGEN:TRACEABILITY -->
| Item | Type | Evidence |
|---|---|---|
| R1 | code | AwakeBar/State/AppStateStore.swift |
| R2 | code | AwakeBar/State/AppStateStore.swift |
| R3 | code | AwakeBar/App/MenuBarController.swift |
| R4 | code | AwakeBar/Services/LoginItemController.swift |
| AC1 | test | AwakeBarTests/AppStateStoreTests.swift |
| AC2 | test | AwakeBarTests/AppStateStoreTests.swift |
| AC3 | test | AwakeBarTests/MenuBarControllerTests.swift |

## Children

<!-- AUTOGEN:CHILDREN -->
- [F-004.01](./F-004.01-safe-state-persistence-boundary.md)
- [F-004.02](./F-004.02-launch-at-login-control.md)

## References

<!-- AUTOGEN:REFERENCES -->
- [F-002](./F-002-menu-bar-experience.md)
- [F-004.01](./F-004.01-safe-state-persistence-boundary.md)
- [F-004.02](./F-004.02-launch-at-login-control.md)
- [F-003](./F-003-closed-lid-admin-control.md)

## API Contract

<!-- AUTOGEN:API_CONTRACT_SUMMARY -->
- `AppStateStore.load()`
- `AppStateStore.save(_:)`
- `LoginItemControlling`

## Impact

<!-- AUTOGEN:IMPACT_MAP -->
- Controls startup behavior and persistence safety boundaries.
- Enables one-time migration cleanup idempotency across relaunches.

## Security

<!-- AUTOGEN:SECURITY_CHECKLIST -->
- [x] Local-only persistence via `UserDefaults`
- [x] Does not cache credentials or privileged tokens

## Budget

<!-- AUTOGEN:BUDGET_CHECKLIST -->
- [x] O(1) load/save operations
- [x] No background sync loops

## Table of Contents

<!-- AUTOGEN:TOC -->
- Summary
- Goals
- Non-Goals
- Requirements
- Acceptance Criteria

<!-- DO NOT EDIT BELOW (AUTOGENERATED) -->

## Changelog

- 2026-02-17: Initial spec created.
- 2026-02-18: Added migration marker persistence for daemon cutover cleanup idempotency.
- 2026-02-18: Split persistence and login-item responsibilities into child specs.
- 2026-02-18: Updated Full Awake terminology for persisted awake intent.
- 2026-02-19: Removed unused transient state fields from persistence boundary and clarified R2 wording.

---
doc_type: feature_spec
id: F-006.01
name: Local Notarization Script
status: active
owner: dshakiba
parent: F-006
children: []
aliases:
  - release-notarize.sh
version: 1.2.0
last_reviewed: 2026-02-19
tags:
  - release
  - cli
risk_level: high
dependencies:
  - F-006
---

# [F-006.01] Local Notarization Script

## Summary

Run full local release packaging flow (sign, notarize, staple, zip, checksum) using environment-provided credentials.

## Goals

- Provide local parity with CI release path.
- Fail fast when required secrets are absent.
- Produce versioned distributable artifacts.

## Non-Goals

- Secret retrieval from remote vaults.
- Multi-platform package production.

## Requirements

- R1: Script must enforce presence of required signing/notary environment variables.
- R2: Script must create and unlock temporary keychain, import Developer ID certificate, and keep login/original keychains visible during identity checks.
- R3: Script must run `xcodegen`, archive release build with hardened runtime enabled binaries, and set `AWAKEBAR_TEAM_ID` from `APPLE_TEAM_ID`.
- R4: Script must notarize, staple, zip final app, and output `.sha256` checksum.
- R5: Script must fail before archive when imported signing identity is not `Developer ID Application` for `APPLE_TEAM_ID`.
- R6: Script must remove temporary secret files and restore user keychain list on exit.
- R7: Script must be re-runnable by removing any prior temporary release keychain before creating a new one.

<!-- AUTOGEN:REQUIREMENTS_CHECKLIST -->
- [x] R1
- [x] R2
- [x] R3
- [x] R4
- [x] R5
- [x] R6
- [x] R7

## Acceptance Criteria

- AC1: Missing any required env var causes immediate non-zero exit.
- AC2: Successful flow emits notarized ZIP in `dist/` and checksum sidecar.
- AC3: Release build verifies with `codesign --verify` and `spctl --assess` before notarization.
- AC4: Wrong certificate type (for example `Apple Development`) fails before archive with actionable error output.
- AC5: Temporary `.p12`, `.p8`, and keychain artifacts are removed when script exits.
- AC6: Re-running script does not fail due to stale `build/release.keychain-db`.

<!-- AUTOGEN:ACCEPTANCE_CHECKLIST -->
- [x] AC1
- [x] AC2
- [x] AC3
- [x] AC4
- [x] AC5
- [x] AC6

## Traceability

<!-- AUTOGEN:TRACEABILITY -->
| Item | Type | Evidence |
|---|---|---|
| R1 | code | Scripts/release-notarize.sh |
| R2 | code | Scripts/release-notarize.sh |
| R3 | code | Scripts/release-notarize.sh |
| R3 | code | project.yml |
| R4 | code | Scripts/release-notarize.sh |
| R5 | code | Scripts/release-notarize.sh |
| R6 | code | Scripts/release-notarize.sh |
| R7 | code | Scripts/release-notarize.sh |
| AC1 | code | Scripts/release-notarize.sh |
| AC2 | manual | Local release execution 2026-02-18 |
| AC3 | code | Scripts/release-notarize.sh |
| AC4 | code | Scripts/release-notarize.sh |
| AC5 | code | Scripts/release-notarize.sh |
| AC6 | code | Scripts/release-notarize.sh |

## Children

<!-- AUTOGEN:CHILDREN -->
- None

## References

<!-- AUTOGEN:REFERENCES -->
- [F-006](./F-006-signed-release-notarization.md)
- [F-003](./F-003-closed-lid-admin-control.md)

## API Contract

<!-- AUTOGEN:API_CONTRACT_SUMMARY -->
- `Scripts/release-notarize.sh`

## Impact

<!-- AUTOGEN:IMPACT_MAP -->
- Enables reproducible local release dry-runs before CI tag publication.

## Security

<!-- AUTOGEN:SECURITY_CHECKLIST -->
- [x] Explicit secret gating
- [x] Keychain-scoped certificate import
- [x] Notarization + staple verification path
- [x] Cert-type and team-bound identity preflight before archive
- [x] Temporary secret material cleanup on exit
- [x] Restores user keychain visibility while using temporary release keychain

## Budget

<!-- AUTOGEN:BUDGET_CHECKLIST -->
- [x] Single-run release pipeline with bounded steps

## Table of Contents

<!-- AUTOGEN:TOC -->
- Summary
- Goals
- Non-Goals
- Requirements
- Acceptance Criteria

<!-- DO NOT EDIT BELOW (AUTOGENERATED) -->

## Changelog

- 2026-02-18: Initial child spec created.
- 2026-02-19: Added cert-type preflight and temporary secret cleanup requirements.
- 2026-02-19: Added stale-keychain cleanup requirement for re-runnable local release execution.
- 2026-02-19: Marked AC2 complete from successful local notarized release and added hardened-runtime/keychain-visibility coverage.

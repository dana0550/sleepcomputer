---
doc_type: feature_spec
id: F-001.01
name: Open-Lid Assertion Lifecycle
status: active
owner: dshakiba
parent: F-001
children: []
aliases:
  - Full Caffeine Assertions
version: 1.0.0
last_reviewed: 2026-02-18
tags:
  - power
  - iokit
risk_level: medium
dependencies:
  - F-001
---

# [F-001.01] Open-Lid Assertion Lifecycle

## Summary

Implement the concrete IOKit assertion lifecycle used by open-lid keep-awake mode.

## Goals

- Acquire both idle and display assertions when enabled.
- Release all assertions when disabled.
- Avoid partial-state leaks on failure.

## Non-Goals

- Managing closed-lid sleep policy.
- Persisting assertion IDs across launches.

## Requirements

- R1: `setEnabled(true)` must no-op when already enabled.
- R2: Enabling must create `kIOPMAssertionTypeNoIdleSleep` and `kIOPMAssertionTypeNoDisplaySleep` assertions.
- R3: If display assertion creation fails, idle assertion must be released before error propagation.
- R4: Disabling must release any non-zero assertion IDs and clear stored IDs.

<!-- AUTOGEN:REQUIREMENTS_CHECKLIST -->
- [x] R1
- [x] R2
- [x] R3
- [x] R4

## Acceptance Criteria

- AC1: Assertion IDs are only retained after both assertion creations succeed.
- AC2: Repeated toggles do not leak assertion IDs.
- AC3: Assertion release errors surface as explicit controller errors.

<!-- AUTOGEN:ACCEPTANCE_CHECKLIST -->
- [x] AC1
- [ ] AC2
- [x] AC3

## Traceability

<!-- AUTOGEN:TRACEABILITY -->
| Item | Type | Evidence |
|---|---|---|
| R1 | code | AwakeBar/Services/OpenLidAssertionController.swift |
| R2 | code | AwakeBar/Services/OpenLidAssertionController.swift |
| R3 | code | AwakeBar/Services/OpenLidAssertionController.swift |
| R4 | code | AwakeBar/Services/OpenLidAssertionController.swift |
| AC1 | code | AwakeBar/Services/OpenLidAssertionController.swift |
| AC2 | manual | Repeated enable/disable verification |
| AC3 | code | AwakeBar/Services/OpenLidAssertionController.swift |

## Children

<!-- AUTOGEN:CHILDREN -->
- None

## References

<!-- AUTOGEN:REFERENCES -->
- [F-001](./F-001-core-awake-control.md)

## API Contract

<!-- AUTOGEN:API_CONTRACT_SUMMARY -->
- `OpenLidAssertionController.setEnabled(_:)`
- `OpenLidAssertionError`

## Impact

<!-- AUTOGEN:IMPACT_MAP -->
- Defines correctness and safety of Full Caffeine runtime behavior.

## Security

<!-- AUTOGEN:SECURITY_CHECKLIST -->
- [x] No privileged helper or shell command usage
- [x] Limited to IOKit assertion APIs

## Budget

<!-- AUTOGEN:BUDGET_CHECKLIST -->
- [x] Constant-time assertion create/release operations

## Table of Contents

<!-- AUTOGEN:TOC -->
- Summary
- Goals
- Non-Goals
- Requirements
- Acceptance Criteria

<!-- DO NOT EDIT BELOW (AUTOGENERATED) -->

## Changelog

- 2026-02-18: Initial child spec created.

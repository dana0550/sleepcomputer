---
doc_type: feature_spec
id: F-003.03
name: Legacy Privilege Cleanup
status: active
owner: dshakiba
parent: F-003
children: []
aliases:
  - Migration Cleanup
version: 1.0.0
last_reviewed: 2026-02-18
tags:
  - migration
  - security
risk_level: high
dependencies:
  - F-003
  - F-004
---

# [F-003.03] Legacy Privilege Cleanup

## Summary

Safely remove AwakeBar-owned legacy privilege artifacts after daemon readiness, with backup-first behavior and guarded PAM handling.

## Goals

- Prevent destructive cleanup of unmanaged files.
- Keep cleanup idempotent across relaunches.
- Preserve backup evidence for rollback/debug.

## Non-Goals

- Cleaning arbitrary third-party sudoers/PAM changes.
- Re-running cleanup continuously.

## Requirements

- R1: Cleanup must copy targeted files into timestamped backup directory before deletion.
- R2: Managed sudoers paths must be removed when present.
- R3: PAM file removal must only occur when content matches known AwakeBar-managed patterns.
- R4: Cleanup result must report cleaned paths, skipped paths, and backup directory.
- R5: App runtime must persist completion marker and skip subsequent cleanup attempts.

<!-- AUTOGEN:REQUIREMENTS_CHECKLIST -->
- [x] R1
- [x] R2
- [x] R3
- [x] R4
- [x] R5

## Acceptance Criteria

- AC1: Managed legacy files are backed up and removed.
- AC2: Unmanaged PAM content is backed up but not removed.
- AC3: After successful first cleanup, relaunch does not invoke cleanup again.

<!-- AUTOGEN:ACCEPTANCE_CHECKLIST -->
- [x] AC1
- [x] AC2
- [ ] AC3

## Traceability

<!-- AUTOGEN:TRACEABILITY -->
| Item | Type | Evidence |
|---|---|---|
| R1 | code | AwakeBarPrivilegedHelper/LegacyCleanupManager.swift |
| R2 | code | AwakeBarPrivilegedHelper/LegacyCleanupManager.swift |
| R3 | code | AwakeBarPrivilegedHelper/LegacyCleanupManager.swift |
| R4 | code | AwakeBarPrivilegedHelper/PrivilegedService.swift |
| R5 | code | AwakeBar/App/MenuBarController.swift |
| R5 | code | AwakeBar/State/AppStateStore.swift |
| AC1 | test | AwakeBarPrivilegedHelperTests/LegacyCleanupPolicyTests.swift |
| AC2 | test | AwakeBarPrivilegedHelperTests/LegacyCleanupPolicyTests.swift |
| AC3 | manual | Relaunch after cleanup completion marker set |

## Children

<!-- AUTOGEN:CHILDREN -->
- None

## References

<!-- AUTOGEN:REFERENCES -->
- [F-003](./F-003-closed-lid-admin-control.md)
- [F-004](./F-004-state-persistence-login.md)
- [ADR-0001](../DECISIONS/ADR-0001-privileged-daemon-cutover.md)

## API Contract

<!-- AUTOGEN:API_CONTRACT_SUMMARY -->
- `LegacyCleanupManager.runCleanup()`
- `LegacyCleanupManager.isAwakeBarManagedPamContent(_:)`
- `LegacyCleanupReport`

## Impact

<!-- AUTOGEN:IMPACT_MAP -->
- Removes old privilege artifacts while preserving forensic backup trail.

## Security

<!-- AUTOGEN:SECURITY_CHECKLIST -->
- [x] Backup-first file mutation policy
- [x] Strict managed-content checks before PAM deletion
- [x] Idempotent post-migration behavior

## Budget

<!-- AUTOGEN:BUDGET_CHECKLIST -->
- [x] One-time execution after readiness
- [x] File operations scoped to finite known path set

## Table of Contents

<!-- AUTOGEN:TOC -->
- Summary
- Goals
- Non-Goals
- Requirements
- Acceptance Criteria

<!-- DO NOT EDIT BELOW (AUTOGENERATED) -->

## Changelog

- 2026-02-18: Initial child spec created.

---
doc_type: feature_spec
id: F-003.02
name: Privileged XPC Transport
status: active
owner: dshakiba
parent: F-003
children: []
aliases:
  - Daemon Client
version: 1.0.0
last_reviewed: 2026-02-18
tags:
  - xpc
  - security
risk_level: high
dependencies:
  - F-003
---

# [F-003.02] Privileged XPC Transport

## Summary

Implement app-side XPC transport to privileged helper with strict connection requirements and timeout handling.

## Goals

- Keep helper communication strongly typed and bounded.
- Fail fast on invalid proxy/interruption/timeout.
- Validate cleanup payload integrity.

## Non-Goals

- Multiple helper endpoints.
- Long-lived streaming sessions.

## Requirements

- R1: Client must connect to privileged mach service defined by `PrivilegedServiceConstants.machServiceName`.
- R2: Client connection must set `AwakeBarPrivilegedServiceXPC` remote interface and helper code-signing requirement.
- R3: Request operations must invalidate connections after completion/failure and return explicit timeout errors.
- R4: Cleanup payload parsing must reject missing `cleanedPaths`, `skippedPaths`, or `backupDirectory` fields.

<!-- AUTOGEN:REQUIREMENTS_CHECKLIST -->
- [x] R1
- [x] R2
- [x] R3
- [x] R4

## Acceptance Criteria

- AC1: Invalid cleanup payload triggers `invalidCleanupPayload`.
- AC2: Connection interruption/invalidation yields `invalidProxy` path.
- AC3: Timeout path returns deterministic `timeout` error.

<!-- AUTOGEN:ACCEPTANCE_CHECKLIST -->
- [x] AC1
- [x] AC2
- [x] AC3

## Traceability

<!-- AUTOGEN:TRACEABILITY -->
| Item | Type | Evidence |
|---|---|---|
| R1 | code | AwakeBar/Services/PrivilegedDaemonClient.swift |
| R2 | code | AwakeBar/Services/PrivilegedDaemonClient.swift |
| R3 | code | AwakeBar/Services/PrivilegedDaemonClient.swift |
| R4 | code | AwakeBar/Services/PrivilegedDaemonClient.swift |
| AC1 | test | AwakeBarTests/PrivilegedDaemonClientTests.swift |
| AC2 | code | AwakeBar/Services/PrivilegedDaemonClient.swift |
| AC3 | code | AwakeBar/Services/PrivilegedDaemonClient.swift |

## Children

<!-- AUTOGEN:CHILDREN -->
- None

## References

<!-- AUTOGEN:REFERENCES -->
- [F-003](./F-003-closed-lid-admin-control.md)
- [F-003.01](./F-003.01-setup-readiness-flow.md)

## API Contract

<!-- AUTOGEN:API_CONTRACT_SUMMARY -->
- `PrivilegedDaemonControlling`
- `PrivilegedDaemonClient`
- `PrivilegedDaemonClientError`

## Impact

<!-- AUTOGEN:IMPACT_MAP -->
- Provides the sole app runtime transport to privileged helper operations.

## Security

<!-- AUTOGEN:SECURITY_CHECKLIST -->
- [x] Enforces helper bundle/team code-signing requirement on client connection
- [x] Fails closed on invalid proxy or payload integrity mismatch

## Budget

<!-- AUTOGEN:BUDGET_CHECKLIST -->
- [x] Request timeout caps worst-case wait
- [x] One short-lived connection per request

## Table of Contents

<!-- AUTOGEN:TOC -->
- Summary
- Goals
- Non-Goals
- Requirements
- Acceptance Criteria

<!-- DO NOT EDIT BELOW (AUTOGENERATED) -->

## Changelog

- 2026-02-18: Initial child spec created.

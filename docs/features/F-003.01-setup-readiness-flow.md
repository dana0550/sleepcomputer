---
doc_type: feature_spec
id: F-003.01
name: Setup Readiness and Approval Flow
status: active
owner: dshakiba
parent: F-003
children: []
aliases:
  - Guided Setup
version: 1.2.0
last_reviewed: 2026-02-20
tags:
  - daemon
  - setup
risk_level: medium
dependencies:
  - F-003
  - F-002
---

# [F-003.01] Setup Readiness and Approval Flow

## Summary

Orchestrate closed-lid helper readiness state, including app-location checks, daemon registration, and approval guidance.

## Goals

- Give deterministic setup status values.
- Keep setup registration explicit and user-driven.
- Expose approval remediation path in System Settings.

## Non-Goals

- Automatically bypassing macOS helper approval.
- Registering helper when app is outside `/Applications`.

## Requirements

- R1: Setup status must return one of `notInApplications`, `notRegistered`, `approvalRequired`, `ready`, or `unavailable`.
- R2: Setup status `ready` requires daemon service `enabled` and successful helper ping.
- R3: `startSetup()` must attempt daemon registration when current status is not enabled, including `.notFound` pre-registration states.
- R4: Approval action must open Login Items settings.
- R5: When daemon status is `.enabled` but helper ping fails, `startSetup()` must run conservative auto recovery: initial retries, then soft retries, before any destructive repair.
- R6: Destructive repair (`unregister`/`register`) must run only within explicit `startSetup()` flow, never inside `refreshStatus()`.
- R7: Destructive repair must be cooldown-limited; repeated setup attempts during cooldown must not churn registration state and must return actionable unavailable messaging.
- R8: Before destructive repair, `startSetup()` must re-check daemon status to avoid stale-status repair when state already changed.

<!-- AUTOGEN:REQUIREMENTS_CHECKLIST -->
- [x] R1
- [x] R2
- [x] R3
- [x] R4
- [x] R5
- [x] R6
- [x] R7
- [x] R8

## Acceptance Criteria

- AC1: App bundle path outside `/Applications` yields `notInApplications`.
- AC2: Service `.requiresApproval` maps to `approvalRequired`.
- AC3: Register failures map to `unavailable` with user-visible context.
- AC4: Service `.notFound` during first-run setup is treated as setup-required and flows through registration.
- AC5: Enabled-but-transiently-unreachable helper can recover to `ready` during soft retries without unregister/register repair.
- AC6: Repeated enabled/unreachable setup attempts within cooldown do not perform repeated destructive repair.
- AC7: Destructive repair runs only after retries are exhausted and setup flow confirms daemon status is still `.enabled`.

<!-- AUTOGEN:ACCEPTANCE_CHECKLIST -->
- [x] AC1
- [x] AC2
- [x] AC3
- [x] AC4
- [x] AC5
- [x] AC6
- [x] AC7

## Traceability

<!-- AUTOGEN:TRACEABILITY -->
| Item | Type | Evidence |
|---|---|---|
| R1 | code | AwakeBar/Services/ClosedLidSetupController.swift |
| R2 | code | AwakeBar/Services/ClosedLidSetupController.swift |
| R3 | code | AwakeBar/Services/ClosedLidSetupController.swift |
| R4 | code | AwakeBar/Services/ClosedLidSetupController.swift |
| R5 | code | AwakeBar/Services/ClosedLidSetupController.swift |
| R6 | code | AwakeBar/Services/ClosedLidSetupController.swift |
| R7 | code | AwakeBar/Services/ClosedLidSetupController.swift |
| R8 | code | AwakeBar/Services/ClosedLidSetupController.swift |
| AC1 | test | AwakeBarTests/ClosedLidSetupControllerTests.swift |
| AC2 | test | AwakeBarTests/ClosedLidSetupControllerTests.swift |
| AC3 | test | AwakeBarTests/ClosedLidSetupControllerTests.swift |
| AC4 | test | AwakeBarTests/ClosedLidSetupControllerTests.swift |
| AC5 | test | AwakeBarTests/ClosedLidSetupControllerTests.swift |
| AC6 | test | AwakeBarTests/ClosedLidSetupControllerTests.swift |
| AC7 | test | AwakeBarTests/ClosedLidSetupControllerTests.swift |

## Children

<!-- AUTOGEN:CHILDREN -->
- None

## References

<!-- AUTOGEN:REFERENCES -->
- [F-003](./F-003-closed-lid-admin-control.md)
- [F-003.06](./F-003.06-smappservice-notfound-registration-recovery.md)
- [F-002](./F-002-menu-bar-experience.md)

## API Contract

<!-- AUTOGEN:API_CONTRACT_SUMMARY -->
- `ClosedLidSetupControlling.refreshStatus()`
- `ClosedLidSetupControlling.startSetup()`
- `ClosedLidSetupControlling.openSystemSettingsForApproval()`

## Impact

<!-- AUTOGEN:IMPACT_MAP -->
- Governs whether privileged closed-lid commands are reachable in UI/runtime.

## Security

<!-- AUTOGEN:SECURITY_CHECKLIST -->
- [x] Blocks privileged runtime access when setup is not ready
- [x] Uses OS-managed helper registration path

## Budget

<!-- AUTOGEN:BUDGET_CHECKLIST -->
- [x] Status checks are event-driven and constant-time per call

## Table of Contents

<!-- AUTOGEN:TOC -->
- Summary
- Goals
- Non-Goals
- Requirements
- Acceptance Criteria

<!-- DO NOT EDIT BELOW (AUTOGENERATED) -->

## Changelog

- 2026-02-18: Initial child spec created.
- 2026-02-19: Clarified `.notFound` compatibility handling for first-run SMAppService registration flow.
- 2026-02-20: Added conservative auto-repair sequencing (soft retries, status re-check, repair cooldown) and explicit non-invasive refresh requirements.

---
doc_type: feature_spec
id: F-004.01
name: Safe State Persistence Boundary
status: active
owner: dshakiba
parent: F-004
children: []
aliases:
  - Safe Persistence
version: 1.0.0
last_reviewed: 2026-02-18
tags:
  - persistence
risk_level: low
dependencies:
  - F-004
---

# [F-004.01] Safe State Persistence Boundary

## Summary

Define exactly which app state fields are persisted versus forced runtime-only values.

## Goals

- Persist only safe user preference fields.
- Avoid persisting stale privileged runtime state.
- Keep persistence schema minimal and explicit.

## Non-Goals

- Versioned state migration framework.
- Remote profile sync.

## Requirements

- R1: Store must persist `openLidEnabled`, `launchAtLoginEnabled`, and `legacyCleanupCompleted` only.
- R2: `load()` must force closed-lid runtime flags to false and setup status to `notRegistered`.
- R3: `load()` must not restore transient notices or transient error messages.

<!-- AUTOGEN:REQUIREMENTS_CHECKLIST -->
- [x] R1
- [x] R2
- [x] R3

## Acceptance Criteria

- AC1: Unit test confirms only safe fields round-trip.
- AC2: Runtime-only closed-lid and transient fields are reset on load.

<!-- AUTOGEN:ACCEPTANCE_CHECKLIST -->
- [x] AC1
- [x] AC2

## Traceability

<!-- AUTOGEN:TRACEABILITY -->
| Item | Type | Evidence |
|---|---|---|
| R1 | code | AwakeBar/State/AppStateStore.swift |
| R2 | code | AwakeBar/State/AppStateStore.swift |
| R3 | code | AwakeBar/State/AppStateStore.swift |
| AC1 | test | AwakeBarTests/AppStateStoreTests.swift |
| AC2 | test | AwakeBarTests/AppStateStoreTests.swift |

## Children

<!-- AUTOGEN:CHILDREN -->
- None

## References

<!-- AUTOGEN:REFERENCES -->
- [F-004](./F-004-state-persistence-login.md)

## API Contract

<!-- AUTOGEN:API_CONTRACT_SUMMARY -->
- `AppStateStore.load()`
- `AppStateStore.save(_:)`

## Impact

<!-- AUTOGEN:IMPACT_MAP -->
- Protects startup behavior from stale privileged state.

## Security

<!-- AUTOGEN:SECURITY_CHECKLIST -->
- [x] Avoids persistent privileged-mode carryover
- [x] Keeps storage local and bounded

## Budget

<!-- AUTOGEN:BUDGET_CHECKLIST -->
- [x] Single UserDefaults read/write set per load/save

## Table of Contents

<!-- AUTOGEN:TOC -->
- Summary
- Goals
- Non-Goals
- Requirements
- Acceptance Criteria

<!-- DO NOT EDIT BELOW (AUTOGENERATED) -->

## Changelog

- 2026-02-18: Initial child spec created.

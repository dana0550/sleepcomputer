---
doc_type: feature_spec
id: F-004.01
name: Safe State Persistence Boundary
status: active
owner: dshakiba
parent: F-004
children: []
aliases:
  - Safe Persistence
version: 1.1.0
last_reviewed: 2026-02-19
tags:
  - persistence
risk_level: low
dependencies:
  - F-004
---

# [F-004.01] Safe State Persistence Boundary

## Summary

Define exactly which app state fields are persisted versus forced runtime-only values.

## Goals

- Persist only safe user preference fields.
- Avoid persisting stale privileged runtime state.
- Keep persistence schema minimal and explicit.

## Non-Goals

- Versioned state migration framework.
- Remote profile sync.

## Requirements

- R1: Store must persist `launchAtLoginEnabled`, `legacyCleanupCompleted`, and bounded override-session metadata only.
- R2: `load()` must force open-lid/closed-lid runtime flags to false and setup status to `notRegistered`.
- R3: `load()` must not restore transient notices or transient error messages and must clear legacy open-lid restore intent keys.

<!-- AUTOGEN:REQUIREMENTS_CHECKLIST -->
- [x] R1
- [x] R2
- [x] R3

## Acceptance Criteria

- AC1: Unit tests confirm only safe fields round-trip and legacy restore-intent key is removed.
- AC2: Runtime-only closed-lid/open-lid and transient fields are reset on load.
- AC3: Unknown override-session schema payloads are dropped.

<!-- AUTOGEN:ACCEPTANCE_CHECKLIST -->
- [x] AC1
- [x] AC2
- [x] AC3

## Traceability

<!-- AUTOGEN:TRACEABILITY -->
| Item | Type | Evidence |
|---|---|---|
| R1 | code | AwakeBar/State/AppStateStore.swift |
| R2 | code | AwakeBar/State/AppStateStore.swift |
| R3 | code | AwakeBar/State/AppStateStore.swift |
| AC1 | test | AwakeBarTests/AppStateStoreTests.swift |
| AC2 | test | AwakeBarTests/AppStateStoreTests.swift |
| AC3 | test | AwakeBarTests/AppStateStoreTests.swift |

## Children

<!-- AUTOGEN:CHILDREN -->
- None

## References

<!-- AUTOGEN:REFERENCES -->
- [F-004](./F-004-state-persistence-login.md)

## API Contract

<!-- AUTOGEN:API_CONTRACT_SUMMARY -->
- `AppStateStore.load()`
- `AppStateStore.save(_:)`
- `AppStateStore.loadOverrideSession()`
- `AppStateStore.saveOverrideSession(_:)`

## Impact

<!-- AUTOGEN:IMPACT_MAP -->
- Protects startup behavior from stale privileged state.
- Preserves bounded restore-session metadata without persisting active awake runtime state.

## Security

<!-- AUTOGEN:SECURITY_CHECKLIST -->
- [x] Avoids persistent privileged-mode carryover
- [x] Keeps storage local and bounded

## Budget

<!-- AUTOGEN:BUDGET_CHECKLIST -->
- [x] Single UserDefaults read/write set per load/save

## Table of Contents

<!-- AUTOGEN:TOC -->
- Summary
- Goals
- Non-Goals
- Requirements
- Acceptance Criteria

<!-- DO NOT EDIT BELOW (AUTOGENERATED) -->

## Changelog

- 2026-02-18: Initial child spec created.
- 2026-02-19: Updated safe persistence boundary for override-session storage and legacy key cleanup.

---
doc_type: feature_spec
id: F-004.03
name: Closed-Lid Override Session Recovery
status: active
owner: dshakiba
parent: F-004
children: []
aliases:
  - Pending Restore Recovery
version: 1.1.0
last_reviewed: 2026-02-19
tags:
  - persistence
  - recovery
  - closed-lid
risk_level: medium
dependencies:
  - F-004
  - F-003
  - F-002
---

# [F-004.03] Closed-Lid Override Session Recovery

## Summary

Capture the system `SleepDisabled` baseline before enabling Full Awake and deterministically restore that baseline on disable, quit, and relaunch recovery paths.

## Goals

- Prevent AwakeBar from leaving system sleep policy in an unintended state after failures or app termination.
- Persist enough session metadata to retry restore when helper readiness is temporarily unavailable.
- Keep restore behavior explicit in menu UI when recovery is pending.

## Non-Goals

- Persisting Full Awake ON intent across launches.
- Managing arbitrary `pmset` keys beyond the tracked `SleepDisabled` key.

## Requirements

- R1: Full Awake enable path must capture a baseline snapshot via `captureManagedOverridesBaseline()` once per active override session.
- R2: Full Awake disable and quit flows must prefer restoring the captured baseline via `restoreManagedOverrides(from:)` over unconditional `setEnabled(false)`.
- R3: Failed restore attempts during quit or launch recovery must persist `pendingRestore` and `lastRestoreError` for retry.
- R4: Setup refresh and launch bootstrap must retry pending restores and clear persisted session state on success.
- R5: Snapshot restore must fail closed when required keys are missing (for example missing `SleepDisabled`).
- R6: Pending-restore retry must not race with Full Awake enable transitions; enable must wait for any in-flight retry before mutating managed state.

<!-- AUTOGEN:REQUIREMENTS_CHECKLIST -->
- [x] R1
- [x] R2
- [x] R3
- [x] R4
- [x] R5
- [x] R6

## Acceptance Criteria

- AC1: Unit tests verify baseline capture occurs once per override session.
- AC2: Unit tests verify quit/bootstrap restore behavior clears session on success and keeps pending session on failure.
- AC3: Unit tests verify restore rejects invalid snapshots that omit `SleepDisabled`.
- AC4: Menu controller exposes pending restore messaging while retry is outstanding.
- AC5: Unit tests verify setup-refresh retry and enable transitions are serialized so pending restore cannot erase or skip baseline capture.

<!-- AUTOGEN:ACCEPTANCE_CHECKLIST -->
- [x] AC1
- [x] AC2
- [x] AC3
- [x] AC4
- [x] AC5

## Traceability

<!-- AUTOGEN:TRACEABILITY -->
| Item | Type | Evidence |
|---|---|---|
| R1 | code | AwakeBar/App/MenuBarController.swift |
| R1 | code | AwakeBar/Services/ClosedLidPmsetController.swift |
| R2 | code | AwakeBar/App/MenuBarController.swift |
| R3 | code | AwakeBar/App/MenuBarController.swift |
| R3 | code | AwakeBar/State/AppStateStore.swift |
| R4 | code | AwakeBar/App/MenuBarController.swift |
| R4 | code | AwakeBar/UI/MenuContentView.swift |
| R5 | code | AwakeBar/Services/ClosedLidPmsetController.swift |
| R6 | code | AwakeBar/App/MenuBarController.swift |
| AC1 | test | AwakeBarTests/MenuBarControllerTests.swift |
| AC2 | test | AwakeBarTests/MenuBarControllerTests.swift |
| AC3 | test | AwakeBarTests/ClosedLidPmsetControllerTests.swift |
| AC4 | test | AwakeBarTests/MenuBarControllerTests.swift |
| AC5 | test | AwakeBarTests/MenuBarControllerTests.swift |

## Children

<!-- AUTOGEN:CHILDREN -->
- None

## References

<!-- AUTOGEN:REFERENCES -->
- [F-004](./F-004-state-persistence-login.md)
- [F-003](./F-003-closed-lid-admin-control.md)
- [F-002](./F-002-menu-bar-experience.md)

## API Contract

<!-- AUTOGEN:API_CONTRACT_SUMMARY -->
- `ClosedLidSleepControlling.captureManagedOverridesBaseline()`
- `ClosedLidSleepControlling.restoreManagedOverrides(from:)`
- `MenuBarController.prepareForTermination()`
- `AppStateStore.loadOverrideSession()`
- `AppStateStore.saveOverrideSession(_:)`

## Impact

<!-- AUTOGEN:IMPACT_MAP -->
- Keeps system sleep policy aligned with pre-toggle state during disable/quit/launch transitions.
- Enables explicit recovery messaging and retry behavior when helper readiness is temporarily unavailable.

## Security

<!-- AUTOGEN:SECURITY_CHECKLIST -->
- [x] Fails closed on invalid or incomplete restore snapshots
- [x] Stores only bounded local recovery metadata (no credentials, no tokens)

## Budget

<!-- AUTOGEN:BUDGET_CHECKLIST -->
- [x] Baseline capture occurs once per session
- [x] Retry work occurs on bootstrap/setup refresh, not background polling loops

## Table of Contents

<!-- AUTOGEN:TOC -->
- Summary
- Goals
- Non-Goals
- Requirements
- Acceptance Criteria

<!-- DO NOT EDIT BELOW (AUTOGENERATED) -->

## Changelog

- 2026-02-19: Initial child spec created for closed-lid baseline capture and pending restore recovery.
- 2026-02-19: Added transition-serialization requirement so pending-restore retries cannot race Full Awake enable.

---
doc_type: feature_spec
id: F-003
name: Closed-Lid Admin Control
status: active
owner: dshakiba
parent: null
children: []
aliases: []
version: 1.1.0
last_reviewed: 2026-02-18
tags:
  - power
  - admin
risk_level: high
dependencies:
  - F-002
---

# [F-003] Closed-Lid Admin Control

## Summary

Provide an admin-authenticated toggle that enables/disables global sleep disable through `pmset`.

## Goals

- Offer in-app control for `disablesleep` without storing credentials.
- Detect externally enabled sleep disable on startup.

## Non-Goals

- Custom privilege helper daemons in v1.

## Requirements

- R1: First privileged closed-lid action performs one-time administrator setup for passwordless `pmset` toggles.
- R2: After successful setup, enable/disable toggles run without repeated password prompts.
- R3: If one-time setup is unavailable or canceled, app falls back to native administrator prompt for the current action.
- R4: Startup probe reports existing `SleepDisabled=1` as external mode state.
- R5: Errors/cancellation preserve prior toggle state.

<!-- AUTOGEN:REQUIREMENTS_CHECKLIST -->
- [ ] R1
- [ ] R2
- [ ] R3
- [ ] R4
- [ ] R5

## Acceptance Criteria

- AC1: `pmset -g` shows `SleepDisabled 1` after successful enable.
- AC2: `pmset -g` shows `SleepDisabled 0` after successful disable.

<!-- AUTOGEN:ACCEPTANCE_CHECKLIST -->
- [ ] AC1
- [ ] AC2

## Traceability

<!-- AUTOGEN:TRACEABILITY -->
| Item | Type | Evidence |
|---|---|---|
| R1 | code | AwakeBar/Services/PrivilegedCommandRunner.swift |
| R2 | code | AwakeBar/Services/PrivilegedCommandRunner.swift |
| R3 | code | AwakeBar/Services/PrivilegedCommandRunner.swift |
| R4 | test | AwakeBarTests/ClosedLidPmsetControllerTests.swift |
| R5 | test | AwakeBarTests/MenuBarControllerTests.swift |
| AC1 | manual | `pmset -g` verification |
| AC2 | manual | `pmset -g` verification |

## Children

<!-- AUTOGEN:CHILDREN -->
- None

## References

<!-- AUTOGEN:REFERENCES -->
- [F-002]

## API Contract

<!-- AUTOGEN:API_CONTRACT_SUMMARY -->
- `ClosedLidSleepControlling.setEnabled(_:)`
- `ClosedLidSleepControlling.readSleepDisabled()`

## Impact

<!-- AUTOGEN:IMPACT_MAP -->
- System-wide sleep behavior may be changed outside app session.

## Security

<!-- AUTOGEN:SECURITY_CHECKLIST -->
- [x] Uses one-time native admin prompt for passwordless setup
- [x] Falls back to native admin prompt if setup unavailable
- [x] Does not persist credentials

## Budget

<!-- AUTOGEN:BUDGET_CHECKLIST -->
- [x] No polling loop; probe only at startup or state changes

## Table of Contents

<!-- AUTOGEN:TOC -->
- Summary
- Goals
- Requirements
- Acceptance Criteria

<!-- DO NOT EDIT BELOW (AUTOGENERATED) -->

## Changelog

- 2026-02-17: Initial spec created.
- 2026-02-17: Added one-time passwordless setup with prompt fallback behavior.

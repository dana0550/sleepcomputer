---
doc_type: feature_spec
id: F-003
name: Closed-Lid Daemon Control
status: active
owner: dshakiba
parent: null
children:
  - F-003.01
  - F-003.02
  - F-003.03
  - F-003.04
aliases:
  - Closed-Lid Admin Control
version: 2.2.0
last_reviewed: 2026-02-19
tags:
  - power
  - admin
  - daemon
risk_level: high
dependencies:
  - F-002
  - F-004
---

# [F-003] Closed-Lid Daemon Control

## Summary

Provide closed-lid keep-awake control using a privileged LaunchDaemon + XPC helper with guided setup and no runtime `sudo`/AppleScript fallback.

## Goals

- Remove repeated password prompts during normal closed-lid toggles.
- Keep a narrow privileged command surface.
- Preserve explicit user control and clear setup state in the menu UI.

## Non-Goals

- Promising permanent Touch ID or PAM behavior across macOS variants.
- Supporting legacy runtime paths (`sudo`, AppleScript, ad-hoc PAM edits) after cutover.

## Requirements

- R1: Closed-lid runtime operations must use daemon-backed XPC only.
- R2: Closed-lid toggle attempts must fail safe when setup is not `ready`.
- R3: App/helper connection paths must enforce code-signing requirements.
- R4: Startup must detect external `SleepDisabled=1` state without auto-enabling closed-lid by-app state.
- R5: Legacy privilege artifacts must be cleaned once after helper readiness and persisted as complete.

<!-- AUTOGEN:REQUIREMENTS_CHECKLIST -->
- [x] R1
- [x] R2
- [x] R3
- [x] R4
- [x] R5

## Acceptance Criteria

- AC1: First-run closed-lid flow transitions through setup states to `ready` after registration/approval.
- AC2: Once helper is ready, closed-lid toggles run without repeated auth prompts from app runtime.
- AC3: Untrusted or invalid XPC callers are rejected by helper connection policy.
- AC4: Legacy cleanup is backup-first and does not delete unmanaged PAM content.
- AC5: Runtime code contains no AppleScript/`sudo` closed-lid execution path.

<!-- AUTOGEN:ACCEPTANCE_CHECKLIST -->
- [x] AC1
- [ ] AC2
- [x] AC3
- [x] AC4
- [x] AC5

## Traceability

<!-- AUTOGEN:TRACEABILITY -->
| Item | Type | Evidence |
|---|---|---|
| R1 | code | AwakeBar/Services/ClosedLidPmsetController.swift |
| R1 | code | AwakeBar/Services/PrivilegedDaemonClient.swift |
| R2 | code | AwakeBar/Services/ClosedLidPmsetController.swift |
| R2 | code | AwakeBar/UI/MenuContentView.swift |
| R3 | code | AwakeBar/Services/PrivilegedDaemonClient.swift |
| R3 | code | AwakeBarPrivilegedHelper/main.swift |
| R3 | code | AwakeBarPrivilegedHelper/PrivilegedService.swift |
| R4 | code | AwakeBar/App/MenuBarController.swift |
| R5 | code | AwakeBar/App/MenuBarController.swift |
| R5 | code | AwakeBarPrivilegedHelper/LegacyCleanupManager.swift |
| AC1 | test | AwakeBarTests/ClosedLidSetupControllerTests.swift |
| AC2 | manual | Closed-lid toggle validation after setup |
| AC3 | code | AwakeBarPrivilegedHelper/PrivilegedService.swift |
| AC4 | test | AwakeBarPrivilegedHelperTests/LegacyCleanupPolicyTests.swift |
| AC5 | code | AwakeBar/Services/ClosedLidPmsetController.swift |

## Children

<!-- AUTOGEN:CHILDREN -->
- [F-003.01](./F-003.01-setup-readiness-flow.md)
- [F-003.02](./F-003.02-privileged-xpc-transport.md)
- [F-003.03](./F-003.03-legacy-privilege-cleanup.md)
- [F-003.04](./F-003.04-helper-packaging-launchd.md)

## References

<!-- AUTOGEN:REFERENCES -->
- [F-002](./F-002-menu-bar-experience.md)
- [F-003.01](./F-003.01-setup-readiness-flow.md)
- [F-003.02](./F-003.02-privileged-xpc-transport.md)
- [F-003.03](./F-003.03-legacy-privilege-cleanup.md)
- [F-003.04](./F-003.04-helper-packaging-launchd.md)
- [F-004](./F-004-state-persistence-login.md)
- [F-004.03](./F-004.03-closed-lid-override-session-recovery.md)
- [ADR-0001](../DECISIONS/ADR-0001-privileged-daemon-cutover.md)

## API Contract

<!-- AUTOGEN:API_CONTRACT_SUMMARY -->
- `ClosedLidSleepControlling.setEnabled(_:)`
- `ClosedLidSleepControlling.readSleepDisabled()`
- `ClosedLidSleepControlling.cleanupLegacyArtifacts()`
- `AwakeBarPrivilegedServiceXPC`

## Impact

<!-- AUTOGEN:IMPACT_MAP -->
- Closed-lid control depends on helper packaging, registration, approval lifecycle, and XPC security posture.
- Startup flow includes external-state detection and one-time cleanup coordination.

## Security

<!-- AUTOGEN:SECURITY_CHECKLIST -->
- [x] No credential storage in app/runtime paths
- [x] Narrow helper command surface (`pmset` + cleanup)
- [x] Bidirectional code-signing requirement checks
- [x] Backup-first cleanup with guarded PAM modifications

## Budget

<!-- AUTOGEN:BUDGET_CHECKLIST -->
- [x] No continuous polling; setup checks and probes are event-driven
- [x] Cleanup runs once after readiness and is marked complete

## Table of Contents

<!-- AUTOGEN:TOC -->
- Summary
- Goals
- Non-Goals
- Requirements
- Acceptance Criteria

<!-- DO NOT EDIT BELOW (AUTOGENERATED) -->

## Changelog

- 2026-02-17: Initial spec created.
- 2026-02-18: Hard cutover to LaunchDaemon + XPC helper with setup-gated runtime.
- 2026-02-18: Split implementation details into child specs for setup, transport, cleanup, and packaging.
- 2026-02-19: Linked closed-lid baseline restore recovery behavior from F-004.03 and updated transport hardening references.

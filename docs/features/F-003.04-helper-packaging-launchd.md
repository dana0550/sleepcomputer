---
doc_type: feature_spec
id: F-003.04
name: Helper Packaging and LaunchDaemon Wiring
status: active
owner: dshakiba
parent: F-003
children: []
aliases:
  - Embedded Helper Packaging
version: 1.2.0
last_reviewed: 2026-02-19
tags:
  - build
  - launchd
risk_level: high
dependencies:
  - F-003
  - F-006
---

# [F-003.04] Helper Packaging and LaunchDaemon Wiring

## Summary

Embed privileged helper executable and launch daemon plist into app bundle and configure launchd service metadata.

## Goals

- Ensure release app bundle contains helper + daemon assets.
- Keep helper mach service and executable path deterministic.
- Preserve code-signing team propagation for trust checks.

## Non-Goals

- Runtime self-install logic outside SMAppService registration.
- Multiple helper binaries.

## Requirements

- R1: Build phase must install helper binary into `Contents/Library/HelperTools/AwakeBarPrivilegedHelper`.
- R2: Build phase must install daemon plist into `Contents/Library/LaunchDaemons/com.dshakiba.AwakeBar.PrivilegedHelper.plist`.
- R3: Daemon plist must define mach service `com.dshakiba.AwakeBar.PrivilegedHelper` (matching helper bundle identifier) and bundle program helper path.
- R4: Helper process listener must apply app-side code-signing requirement using configured team ID when present.
- R5: Helper build configuration must enforce bundle-identifier-based code-signing identity and preserve Info.plist metadata in signed executable output.

<!-- AUTOGEN:REQUIREMENTS_CHECKLIST -->
- [x] R1
- [x] R2
- [x] R3
- [x] R4
- [x] R5

## Acceptance Criteria

- AC1: Archive output contains helper binary and daemon plist in expected bundle locations.
- AC2: Helper listens on configured mach service name.
- AC3: Team ID propagation and helper signing identifier validation work in signed build contexts.

<!-- AUTOGEN:ACCEPTANCE_CHECKLIST -->
- [ ] AC1
- [x] AC2
- [x] AC3

## Traceability

<!-- AUTOGEN:TRACEABILITY -->
| Item | Type | Evidence |
|---|---|---|
| R1 | code | project.yml |
| R2 | code | project.yml |
| R3 | code | AwakeBar/LaunchDaemons/com.dshakiba.AwakeBar.PrivilegedHelper.plist |
| R4 | code | AwakeBarPrivilegedHelper/main.swift |
| R4 | code | AwakeBarShared/PrivilegedServiceConstants.swift |
| R5 | code | project.yml |
| R5 | code | AwakeBar.xcodeproj/project.pbxproj |
| AC1 | manual | Archive bundle inspection |
| AC2 | code | AwakeBarPrivilegedHelper/main.swift |
| AC3 | code | Scripts/smoke-check-app.sh |
| AC3 | manual | Signed release build with `AWAKEBAR_TEAM_ID` |

## Children

<!-- AUTOGEN:CHILDREN -->
- None

## References

<!-- AUTOGEN:REFERENCES -->
- [F-003](./F-003-closed-lid-admin-control.md)
- [F-003.05](./F-003.05-helper-signing-identity-launch-constraints.md)
- [F-006](./F-006-signed-release-notarization.md)

## API Contract

<!-- AUTOGEN:API_CONTRACT_SUMMARY -->
- `PrivilegedServiceConstants.machServiceName`
- `PrivilegedServiceConstants.daemonPlistName`

## Impact

<!-- AUTOGEN:IMPACT_MAP -->
- Defines packaging preconditions required for closed-lid helper setup readiness.

## Security

<!-- AUTOGEN:SECURITY_CHECKLIST -->
- [x] Helper service identity is explicit and signed
- [x] LaunchDaemon metadata is deterministic and versioned in repo

## Budget

<!-- AUTOGEN:BUDGET_CHECKLIST -->
- [x] Packaging overhead limited to helper binary + plist copy steps

## Table of Contents

<!-- AUTOGEN:TOC -->
- Summary
- Goals
- Non-Goals
- Requirements
- Acceptance Criteria

<!-- DO NOT EDIT BELOW (AUTOGENERATED) -->

## Changelog

- 2026-02-18: Initial child spec created.
- 2026-02-18: Updated mach service requirement to `.v2`.
- 2026-02-19: Added helper signing-identifier and Info.plist-binding requirement with smoke-check coverage.
- 2026-02-19: Aligned daemon mach service label with helper bundle identifier to avoid launch-constraint drift.

---
doc_type: feature_spec
id: F-003.06
name: SMAppService NotFound Registration Recovery
status: active
owner: dshakiba
parent: F-003
children: []
aliases:
  - BTM Record Recovery
version: 1.0.0
last_reviewed: 2026-02-19
tags:
  - daemon
  - setup
  - compatibility
risk_level: medium
dependencies:
  - F-003.01
  - F-003.04
---

# [F-003.06] SMAppService NotFound Registration Recovery

## Summary

Normalize `SMAppService.Status.notFound` handling so first-run setup treats missing BTM records as setup-required and executes registration instead of hard-failing.

## Goals

- Prevent false-negative setup failures on macOS builds where `notFound` means "record not yet registered."
- Preserve fail-closed behavior when registration still does not persist.
- Keep setup behavior deterministic across macOS versions.

## Non-Goals

- Bypassing helper approval requirements in System Settings.
- Relaxing privileged helper identity or launch-constraint checks.

## Requirements

- R1: `refreshStatus()` must map `SMAppService.Status.notFound` to `notRegistered` while app location constraints are satisfied.
- R2: `startSetup()` must treat initial `SMAppService.Status.notFound` as setup-required and attempt registration.
- R3: If service status remains `notFound` or `notRegistered` after registration attempt, setup must fail closed with an explicit persistence error.

<!-- AUTOGEN:REQUIREMENTS_CHECKLIST -->
- [x] R1
- [x] R2
- [x] R3

## Acceptance Criteria

- AC1: `refreshStatus()` returns `notRegistered` when daemon service status is `notFound`.
- AC2: `startSetup()` invoked from `notFound` performs one registration attempt and can transition to `ready`.
- AC3: `startSetup()` returns `unavailable` with persistence guidance when `notFound` remains after registration.

<!-- AUTOGEN:ACCEPTANCE_CHECKLIST -->
- [x] AC1
- [x] AC2
- [x] AC3

## Traceability

<!-- AUTOGEN:TRACEABILITY -->
| Item | Type | Evidence |
|---|---|---|
| R1 | code | AwakeBar/Services/ClosedLidSetupController.swift |
| R2 | code | AwakeBar/Services/ClosedLidSetupController.swift |
| R3 | code | AwakeBar/Services/ClosedLidSetupController.swift |
| AC1 | test | AwakeBarTests/ClosedLidSetupControllerTests.swift |
| AC2 | test | AwakeBarTests/ClosedLidSetupControllerTests.swift |
| AC3 | test | AwakeBarTests/ClosedLidSetupControllerTests.swift |

## Children

<!-- AUTOGEN:CHILDREN -->
- None

## References

<!-- AUTOGEN:REFERENCES -->
- [F-003](./F-003-closed-lid-admin-control.md)
- [F-003.01](./F-003.01-setup-readiness-flow.md)
- [F-003.04](./F-003.04-helper-packaging-launchd.md)

## API Contract

<!-- AUTOGEN:API_CONTRACT_SUMMARY -->
- `ClosedLidSetupControlling.refreshStatus()`
- `ClosedLidSetupControlling.startSetup()`

## Impact

<!-- AUTOGEN:IMPACT_MAP -->
- Removes a first-run setup dead-end where BTM had no daemon record yet.
- Keeps setup-retry messaging aligned with registration persistence outcomes.

## Security

<!-- AUTOGEN:SECURITY_CHECKLIST -->
- [x] Retains fail-closed behavior when privileged helper registration cannot be confirmed
- [x] Does not expand helper command surface or trust model

## Budget

<!-- AUTOGEN:BUDGET_CHECKLIST -->
- [x] Uses constant-time status mapping with no additional background loops

## Table of Contents

<!-- AUTOGEN:TOC -->
- Summary
- Goals
- Non-Goals
- Requirements
- Acceptance Criteria

<!-- DO NOT EDIT BELOW (AUTOGENERATED) -->

## Changelog

- 2026-02-19: Spec created from SMAppService `notFound` regression fix and tests.
